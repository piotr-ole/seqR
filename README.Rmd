---
output: github_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  collapse = TRUE,
  comment = "#>",
  out.width = "100%"
)
```

```{r, include = FALSE}
library(seqR)
```

# seqR

<!-- badges: start -->
[![R build status](https://github.com/slowikj/seqR/workflows/R-CMD-check/badge.svg)](https://github.com/slowikj/seqR/actions)
<!-- badges: end -->

## Overview

`seqR` is an R package for fast k-mer counting. It provides

* highly optimized (the core algorithm is written in C++)
* in-memory
* probabilistic (with configurable dimensionality of a hash value
used for storing k-mers internally),
* multi-threaded

implementation that supports 

* various variants of k-mers (contiguous, gapped, and positional counterparts)
* all biological sequences (e.g., nucleic acids and proteins)

### Exported functions

The package provides three functions that facilitate k-mer counting
and processing k-mer matrices:

* `count_kmers` (used for counting k-mers of one type)
* `count_multimers` (a wrapper of `count_kmers`, used for counting k-mers of many types in a single invocation of the function)
* `rbind_columnwise` (a helper function used for merging several k-mer matrices that do not have same sets of columns)

## Package installation and loading

It is possible to download the development version directly from GitHub repository:

```{r, eval=FALSE}
# install.packages("devtools")
devtools::install_github("slowikj/seqR")
```

## Supported input sequences

The package supports all types of biological sequences, in particular,
nucleic acids and proteins. The sequences can be represented as the input
in following ways:

### String vector

```{r}
count_kmers(c("AADVS", "FFSFAFA"),
            k=2)
```

This representation is more efficient and recommended to use.
However, it does not support multi-character alphabets,
as opposed to the second representation.

### List of string vectors

```{r}
count_kmers(list(c("A", "A", "A", "AA", "V"),
                 c("VA", "A", "A", "G", "D", "D")),
            k=2)
```

## Supported variants of k-mers

There are four major variants of k-mers that the `seqR` package supports
(for more detail see the documentation).

### Contiguous k-mers

```{r}
count_kmers(c("DDDVSVAA", "FFSFSVAAA"),
            k=5)
```

### Gapped k-mers

```{r}
count_kmers(c("DDDVSVAA", "FFSFSVAAA"),
            kmer_gaps=c(2, 0)) # gapped 3-mer template: X__XX
```

### Positional contiguous k-mers

```{r}
count_kmers(c("DDDVSVAA", "FFSFSVAAA"),
            k=5,
            positional=TRUE)
```

### Positional gapped k-mers

```{r}
count_kmers(c("DDDVSVAA", "FFSFSVAAA"),
            kmer_gaps=c(2, 0), # gapped 3-mer template: X__XX
            positional=TRUE)
```

## Result type

The result is the k-mer counting procedure is a k-mer matrix,
represented as a **sparse matrix** (see [package Matrix](https://cran.r-project.org/web/packages/Matrix/index.html)).

The i-th row of the result matrix corresponds to the i-th input sequence
and contains the information about particular occurrences of k-mers.
On the other hand, columns correspond to k-mers found in input sequences
and they are represented in a human-readable form (for more detail see the documentation).

Due to the usage of a sparse matrix representation,
a signification memory optimization is achieved.

```{r, message=FALSE, warning=FALSE}
get_random_string_vector <- function(seq_num, seq_len, alphabet, seed=123) {
  set.seed(seed)
  sapply(1:seq_num,
         function(n) paste0(sample(alphabet, seq_len, replace=TRUE), collapse=""))
}

r <- count_kmers(get_random_string_vector(300, 1000, LETTERS),
                 k=4)
print(pryr::object_size(r))
print(pryr::object_size(as.matrix(r)))
```

Importantly, such a representation is supported by machine learning packages
such as [ranger](https://cran.r-project.org/web/packages/ranger/index.html)
and [xgboost](https://cran.r-project.org/web/packages/xgboost/index.html).


## Extra features

In order to improve user experience and meet custom needs,
several extra features are provided.

### configurable k-mer alphabet

A k-mer alphabet specifies which elements of a sequence
should be considered during the k-mer counting procedure.

K-mer counting using the alphabet derived from input sequences:

```{r}
count_kmers(c("VAAAAHDFAA", "KKKKAKAAVA"),
            k=4)
```

K-mer counting using a custom alphabet:

```{r}
count_kmers(c("VAAAAHDFAA", "KKKKAKAAVA"),
            k=4,
            kmer_alphabet = c("A", "K"))
```

### configurable batch size

This parameter specifies how many sequences are processed in a (multi-threaded) single step
(for more detail see the documentation) and it is available
only for custom tweaking/optimization purpose.
For instance, a user can specify single-threaded mode by setting this parameter to 1.

Below there is the comparison of speed performance between single-threaded and multi-threaded mode.

```{r}
sequences <- get_random_string_vector(seq_num = 200, seq_len = 1000, alphabet = LETTERS)
microbenchmark::microbenchmark(
  multithreaded = count_kmers(sequences, k=5, batch_size = 200),
  singlethreaded = count_kmers(sequences, k=5, batch_size = 1),
  times=11
)
```

### verbose mode

```{r}
count_kmers(c("VAAAAHDFAA", "KKKKAKAAVA", "ASDDA"),
            k=3,
            batch_size=1,
            verbose = TRUE)
```


### configurable dimension of the hash value of a k-mer

As the core k-mer counting algorithm intensively takes advantage of hashing functions,
`seqR` package is a probabilistic solution.
However, due to the application of multidimensional hash values,
a user can specify the length of the hash vector, and, thus, increase the probability
of a correct result.

Nevertheless, for small values of `k` (`k <= 12`),
the result is certainly correct for the default value (i.e., `hash_size = 2`).

### compute k-mers with or without their frequencies

Compare the following two code snippets:

```{r}
count_kmers(c("AAAAAAADFSSAAAA", "AADADADADDAD"),
            k=3,
            with_kmer_counts=FALSE)
```

```{r}
count_kmers(c("AAAAAAADFSSAAAA", "AADADADADDAD"),
            k=3,
            with_kmer_counts=TRUE)
```


### compute a result k-mer matrix with or without human-readable k-mer (column) names

Compare the following two code snippets:

```{r}
count_kmers(c("AAAAAAADFSSAAAA", "AADADADADDAD"),
            k=3,
            with_kmer_names=FALSE)
```

```{r}
count_kmers(c("AAAAAAADFSSAAAA", "AADADADADDAD"),
            k=3,
            with_kmer_names=TRUE)
```

### count k-mers of several types in a single function invocation

```{r}
count_multimers(c("AAAAAAADFSSAAAA", "AADADADADDAD"),
                k_vector=c(1,2,3,4),
                verbose=TRUE)
```

### merge (rbind) two k-mer matrices derived from distinct sequences

As `rbind` function does not work correctly if all input matrices have equivalent sets of columns,
`seqR` package provides a new function (`rbind_columnwise`) to satisfy this use case:

```{r}
mA <- count_kmers(c("AAAAAAADFSSAAAA", "AADADADADDAD"),
                  k=1)
mB <- count_kmers(c("VVVVVAAVA", "ADSDDD", "AAAAAV"),
                  k=1)

rbind_columnwise(mA, mB)
```
    

## Citation

[TODO]
